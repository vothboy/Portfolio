{"ast":null,"code":"'use strict';\n\nvar TYPES = require('./datatypes').TYPES;\n\nvar declareType = require('./datatypes').declare;\n\nvar objectHasProperty = require('./utils').objectHasProperty;\n\nvar MAX = 65535; // (1 << 16) - 1\n\nvar JSON_COLUMN_ID = 'JSON_F52E2B61-18A1-11d1-B105-00805F49916B';\n\nfunction Table(name) {\n  if (name) {\n    var parsed = Table.parseName(name);\n    this.name = parsed.name;\n    this.schema = parsed.schema;\n    this.database = parsed.database;\n    this.path = (this.database ? \"[\".concat(this.database, \"].\") : '') + (this.schema ? \"[\".concat(this.schema, \"].\") : '') + \"[\".concat(this.name, \"]\");\n    this.temporary = this.name.charAt(0) === '#';\n  }\n\n  this.columns = [];\n  this.rows = [];\n  Object.defineProperty(this.columns, 'add', {\n    value: function value(name, column, options) {\n      if (column == null) {\n        throw new Error('Column data type is not defined.');\n      }\n\n      if (column instanceof Function) {\n        column = column();\n      }\n\n      options = options || {};\n      column.name = name;\n      ['nullable', 'primary', 'identity', 'readOnly', 'length'].forEach(function (prop) {\n        if (objectHasProperty(options, prop)) {\n          column[prop] = options[prop];\n        }\n      });\n      return this.push(column);\n    }\n  });\n  Object.defineProperty(this.rows, 'add', {\n    value: function value() {\n      return this.push(Array.prototype.slice.call(arguments));\n    }\n  });\n}\n/*\n@private\n*/\n\n\nTable.prototype._makeBulk = function _makeBulk() {\n  for (var i = 0; i < this.columns.length; i++) {\n    var col = this.columns[i];\n\n    switch (col.type) {\n      case TYPES.Date:\n      case TYPES.DateTime:\n      case TYPES.DateTime2:\n        for (var j = 0; j < this.rows.length; j++) {\n          var dateValue = this.rows[j][i];\n\n          if (typeof dateValue === 'string' || typeof dateValue === 'number') {\n            var date = new Date(dateValue);\n\n            if (isNaN(date.getDate())) {\n              throw new TypeError('Invalid date value passed to bulk rows');\n            }\n\n            this.rows[j][i] = date;\n          }\n        }\n\n        break;\n\n      case TYPES.Xml:\n        col.type = TYPES.NVarChar(MAX).type;\n        break;\n\n      case TYPES.UDT:\n      case TYPES.Geography:\n      case TYPES.Geometry:\n        col.type = TYPES.VarBinary(MAX).type;\n        break;\n\n      default:\n        break;\n    }\n  }\n\n  return this;\n};\n\nTable.prototype.declare = function declare() {\n  var pkey = this.columns.filter(function (col) {\n    return col.primary === true;\n  }).map(function (col) {\n    return col.name;\n  });\n  var cols = this.columns.map(function (col) {\n    var def = [\"[\".concat(col.name, \"] \").concat(declareType(col.type, col))];\n\n    if (col.nullable === true) {\n      def.push('null');\n    } else if (col.nullable === false) {\n      def.push('not null');\n    }\n\n    if (col.primary === true && pkey.length === 1) {\n      def.push('primary key');\n    }\n\n    return def.join(' ');\n  });\n  var constraint = pkey.length > 1 ? \", constraint PK_\".concat(this.temporary ? this.name.substr(1) : this.name, \" primary key (\").concat(pkey.join(', '), \")\") : '';\n  return \"create table \".concat(this.path, \" (\").concat(cols.join(', ')).concat(constraint, \")\");\n};\n\nTable.fromRecordset = function fromRecordset(recordset, name) {\n  var t = new this(name);\n\n  for (var colName in recordset.columns) {\n    if (objectHasProperty(recordset.columns, colName)) {\n      var col = recordset.columns[colName];\n      t.columns.add(colName, {\n        type: col.type,\n        length: col.length,\n        scale: col.scale,\n        precision: col.precision\n      }, {\n        nullable: col.nullable,\n        identity: col.identity,\n        readOnly: col.readOnly\n      });\n    }\n  }\n\n  if (t.columns.length === 1 && t.columns[0].name === JSON_COLUMN_ID) {\n    for (var i = 0; i < recordset.length; i++) {\n      t.rows.add(JSON.stringify(recordset[i]));\n    }\n  } else {\n    var _loop = function _loop(_i) {\n      t.rows.add.apply(t.rows, t.columns.map(function (col) {\n        return recordset[_i][col.name];\n      }));\n    };\n\n    for (var _i = 0; _i < recordset.length; _i++) {\n      _loop(_i);\n    }\n  }\n\n  return t;\n};\n\nTable.parseName = function parseName(name) {\n  var length = name.length;\n  var cursor = -1;\n  var buffer = '';\n  var escaped = false;\n  var path = [];\n\n  while (++cursor < length) {\n    var char = name.charAt(cursor);\n\n    if (char === '[') {\n      if (escaped) {\n        buffer += char;\n      } else {\n        escaped = true;\n      }\n    } else if (char === ']') {\n      if (escaped) {\n        escaped = false;\n      } else {\n        throw new Error('Invalid table name.');\n      }\n    } else if (char === '.') {\n      if (escaped) {\n        buffer += char;\n      } else {\n        path.push(buffer);\n        buffer = '';\n      }\n    } else {\n      buffer += char;\n    }\n  }\n\n  if (buffer) {\n    path.push(buffer);\n  }\n\n  switch (path.length) {\n    case 1:\n      return {\n        name: path[0],\n        schema: null,\n        database: null\n      };\n\n    case 2:\n      return {\n        name: path[1],\n        schema: path[0],\n        database: null\n      };\n\n    case 3:\n      return {\n        name: path[2],\n        schema: path[1],\n        database: path[0]\n      };\n\n    default:\n      throw new Error('Invalid table name.');\n  }\n};\n\nmodule.exports = Table;","map":null,"metadata":{},"sourceType":"script"}